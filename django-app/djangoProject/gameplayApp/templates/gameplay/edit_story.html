{% extends 'gameplay/base.html' %}

{% block title %}Edit Story - NAHB{% endblock %}

{% block content %}
<h2>‚úèÔ∏è Edit: {{ story.title }}</h2>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
    <div class="card">
        <h3>üìñ Story Info</h3>
        <p><strong>Title:</strong> {{ story.title }}</p>
        <p><strong>Status:</strong> 
            <span style="color: {% if story.status == 'published' %}green{% else %}orange{% endif %};">
                {{ story.status|upper }}
            </span>
        </p>
        <p><strong>Start Page:</strong> {% if story.start_page_id %}#{{ story.start_page_id }}{% else %}Not set{% endif %}</p>
        
        <!-- Publish/Unpublish Button -->
        <form method="POST" style="margin-top: 15px;">
            {% csrf_token %}
            <button type="submit" name="publish" class="btn" 
                    style="background: {% if story.status == 'published' %}orange{% else %}green{% endif %};">
                {% if story.status == 'published' %}
                    üì¶ Unpublish (Make Draft)
                {% else %}
                    ‚úÖ Publish Story
                {% endif %}
            </button>
        </form>
    </div>
    
    <div class="card">
        <h3>‚ûï Add Page</h3>
        <form method="POST" action="{% url 'create_page' story.id %}">
            {% csrf_token %}
            <textarea name="text" required placeholder="Page text..."></textarea>
            <label>
                <input type="checkbox" name="is_ending" id="is_ending"> Ending page
            </label>
            <div id="ending_label_field" style="display: none;">
                <input type="text" name="ending_label" placeholder="e.g., Happy Ending, Bad Ending">
            </div>
            <!-- Level 20: Illustration support -->
            <label><strong>Illustration URL (optional):</strong></label>
            <input type="text" name="illustration" placeholder="https://example.com/image.jpg">
            <small style="display: block; color: #666; margin-bottom: 10px;">
                Add an image URL to illustrate this page
            </small>
            <button type="submit" class="btn">Create Page</button>

            <script>
            document.getElementById('is_ending').addEventListener('change', function() {
                document.getElementById('ending_label_field').style.display = 
                    this.checked ? 'block' : 'none';
            });
            </script>
        </form>
    </div>
</div>

<div class="card">
    <h3>üìÑ Pages ({{ pages|length }})</h3>
    {% if pages %}
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
        {% for page in pages %}
        <div class="card" style="background: {% if page.is_ending %}#d4edda{% else %}#f8f9fa{% endif %};">
            <h4>Page {{ forloop.counter }}{% if page.id == story.start_page_id %}‚≠ê{% endif %}</h4>
            <p>{{ page.text|truncatewords:15 }}</p>
            
            {% if page.is_ending %}
                <p style="color: #155724;"><strong>üèÅ {{ page.ending_label|default:"Ending" }}</strong></p>
            {% else %}
                <p><strong>Choices ({{ page.choices|length }}):</strong></p>
                <ul style="font-size: 0.9em;">
                    {% for choice in page.choices %}
                    <li>
                        {{ choice.text|truncatewords:5 }} ‚Üí 
                        {% for p in pages %}
                            {% if p.id == choice.next_page_id %}
                                Page {{ forloop.counter }}
                            {% endif %}
                        {% endfor %}
                    </li>
                    {% empty %}
                    <li style="color: #dc3545;">No choices!</li>
                    {% endfor %}
                </ul>
                
                <form method="POST" action="{% url 'create_choice' page.id %}" style="margin-top: 10px;">
                    {% csrf_token %}
                    <input type="text" name="text" placeholder="Choice text" required>
                    <select name="next_page_id" required>
                        <option value="">-- Next page --</option>
                        {% for p in pages %}
                        <option value="{{ p.id }}">Page {{ forloop.counter }}{% if p.is_ending %} (Ending){% endif %}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn" style="padding: 5px 10px;">Add Choice</button>
                </form>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p>No pages yet.</p>
    {% endif %}
</div>

<div style="text-align: center; margin-top: 20px;">
    <a href="{% url 'story_list' %}" class="btn" style="background: #6c757d;">‚Üê Back</a>
    {% if story.start_page_id %}
    <a href="{% url 'play_story' story.id %}" class="btn">‚ñ∂Ô∏è Test Play</a>
    {% endif %}
</div>
{% endblock %}