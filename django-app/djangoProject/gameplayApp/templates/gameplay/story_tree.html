{% extends 'gameplay/base.html' %}

{% block title %}Story Tree - {{ story.title }}{% endblock %}

{% block content %}
<h2>ğŸŒ³ Story Structure: {{ story.title }}</h2>

<style>
#network {
    height: 600px; 
    border: 1px solid #ddd;
    overflow: hidden;  /* Prevent scroll zoom */
}

/* Prevent page scroll when mouse is over network */
#network canvas {
    outline: none;
}
</style>

<div class="card" style="background: #e7f3ff;">
    <p><strong>Visualization:</strong> Interactive graph showing all pages and choices</p>
    <p>
        <span style="background: #28a745; color: white; padding: 5px 10px; border-radius: 3px;">â­ Start Page</span>
        <span style="background: #dc3545; color: white; padding: 5px 10px; border-radius: 3px;">ğŸ Ending</span>
        <span style="background: #6c757d; color: white; padding: 5px 10px; border-radius: 3px;">ğŸ“„ Normal Page</span>
    </p>
</div>

<div class="card" style="background: #e7f3ff; margin-bottom: 10px;">
    <p><strong>Controls:</strong></p>
    <button onclick="network.fit()" class="btn" style="padding: 5px 15px; margin-right: 5px;">
        ğŸ” Fit to Screen
    </button>
    <button onclick="network.moveTo({scale: network.getScale() * 1.2})" class="btn" style="padding: 5px 15px; margin-right: 5px;">
        â• Zoom In
    </button>
    <button onclick="network.moveTo({scale: network.getScale() * 0.8})" class="btn" style="padding: 5px 15px;">
        â– Zoom Out
    </button>
</div>

<!-- Vis.js Network Graph -->
<div class="card">
    <div id="network" style="height: 600px; border: 1px solid #ddd;"></div>
</div>

<!-- Include Vis.js -->
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script>
    // Prepare data
    const nodes = new vis.DataSet([
        {% for node in nodes %}
        {
            id: {{ node.id }},
            label: "Page {{ node.id }}\n{{ node.text|truncatewords:8 }}",
            color: {% if node.is_start %}'#28a745'{% elif node.is_ending %}'#dc3545'{% else %}'#667eea'{% endif %},
            font: { color: 'white', size: 14 },
            shape: {% if node.is_ending %}'box'{% else %}'ellipse'{% endif %},
            title: "{% if node.is_ending %}{{ node.ending_label }}{% else %}Page {{ node.id }}{% endif %}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]);

    const edges = new vis.DataSet([
        {% for edge in edges %}
        {
            from: {{ edge.from }},
            to: {{ edge.to }},
            label: "{{ edge.label }}",
            arrows: 'to',
            font: { size: 11, align: 'middle' }
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]);

    // Create network
    const container = document.getElementById('network');
    const data = { nodes: nodes, edges: edges };
    const options = {
        layout: {
            hierarchical: {
                direction: 'UD',
                sortMethod: 'directed',
                levelSeparation: 150,
                nodeSpacing: 200
            }
        },
        physics: {
            enabled: false
        },
        edges: {
            smooth: {
                type: 'cubicBezier',
                forceDirection: 'vertical'
            }
        },
        interaction: {
            zoomView: false,           // DISABLE zoom with scroll
            dragView: true,            // Still allow dragging
            navigationButtons: true    // Add zoom buttons instead
        }
    };
    
    const network = new vis.Network(container, data, options);

    // Zoom functions
    function zoomIn() {
        const scale = network.getScale();
        network.moveTo({ scale: scale * 1.2 });
    }
    
    function zoomOut() {
        const scale = network.getScale();
        network.moveTo({ scale: scale * 0.8 });
    }
    
    // Fit to screen on load
    setTimeout(() => network.fit(), 100);
</script>

<div style="text-align: center; margin-top: 20px;">
    <a href="{% url 'story_detail' story.id %}" class="btn" style="background: #6c757d;">â† Back to Story</a>
    <a href="{% url 'edit_story' story.id %}" class="btn">âœï¸ Edit Structure</a>
</div>
{% endblock %}